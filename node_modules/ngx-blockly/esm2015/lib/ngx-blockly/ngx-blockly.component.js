import { ElementRef, Component, EventEmitter, HostListener, Input, Output, ViewChild } from '@angular/core';
import { NgxBlocklyGenerator } from './ngx-blockly.config';
import * as Blockly from 'blockly/core';
import 'blockly/dart';
import 'blockly/javascript';
import 'blockly/lua';
import 'blockly/php';
import 'blockly/python';
import * as i0 from "@angular/core";
export class NgxBlocklyComponent {
    constructor() {
        this.config = {};
        this.customBlocks = [];
        this.readOnly = false;
        this.workspaceCreate = new EventEmitter();
        this.workspaceChange = new EventEmitter();
        this.toolboxChange = new EventEmitter();
        this.dartCode = new EventEmitter();
        this.javascriptCode = new EventEmitter();
        this.luaCode = new EventEmitter();
        this.phpCode = new EventEmitter();
        this.pythonCode = new EventEmitter();
        this.xmlCode = new EventEmitter();
        this._finishedLoading = false;
    }
    static initCustomBlocks(blocks) {
        if (blocks) {
            for (const customBlock of blocks) {
                Blockly.Blocks[customBlock.type] = {
                    init: function () {
                        const block = new customBlock.class(customBlock.type, customBlock.blockMutator, ...customBlock.args);
                        block.init(this);
                        this.mixin({
                            blockInstance: block
                        });
                    }
                };
                if (typeof Blockly[NgxBlocklyGenerator.PYTHON] !== 'undefined') {
                    Blockly[NgxBlocklyGenerator.PYTHON][customBlock.type] = function (b) {
                        return b.blockInstance.toPythonCode(b);
                    };
                }
                if (typeof Blockly[NgxBlocklyGenerator.DART] !== 'undefined') {
                    Blockly[NgxBlocklyGenerator.DART][customBlock.type] = function (b) {
                        return b.blockInstance.toDartCode(b);
                    };
                }
                if (typeof Blockly[NgxBlocklyGenerator.JAVASCRIPT] !== 'undefined') {
                    Blockly[NgxBlocklyGenerator.JAVASCRIPT][customBlock.type] = function (b) {
                        return b.blockInstance.toJavaScriptCode(b);
                    };
                }
                if (typeof Blockly[NgxBlocklyGenerator.LUA] !== 'undefined') {
                    Blockly[NgxBlocklyGenerator.LUA][customBlock.type] = function (b) {
                        return b.blockInstance.toLuaCode(b);
                    };
                }
                if (typeof Blockly[NgxBlocklyGenerator.PHP] !== 'undefined') {
                    Blockly[NgxBlocklyGenerator.PHP][customBlock.type] = function (b) {
                        return b.blockInstance.toPHPCode(b);
                    };
                }
                if (customBlock.blockMutator) {
                    const mutator_mixin = {
                        mutationToDom: function () {
                            return customBlock.blockMutator.mutationToDom.call(customBlock.blockMutator, this);
                        },
                        domToMutation: function (xmlElement) {
                            customBlock.blockMutator.domToMutation.call(customBlock.blockMutator, this, xmlElement);
                        }
                    };
                    if (customBlock.blockMutator.blockList && customBlock.blockMutator.blockList.length > 0) {
                        mutator_mixin.decompose = function (workspace) {
                            return customBlock.blockMutator.decompose.call(customBlock.blockMutator, this, workspace);
                        };
                        mutator_mixin.compose = function (topBlock) {
                            customBlock.blockMutator.compose.call(customBlock.blockMutator, this, topBlock);
                        };
                        mutator_mixin.saveConnections = function (containerBlock) {
                            customBlock.blockMutator.saveConnections.call(customBlock.blockMutator, this, containerBlock);
                        };
                    }
                    Blockly.Extensions.unregister(customBlock.blockMutator.name);
                    Blockly.Extensions.registerMutator(customBlock.blockMutator.name, mutator_mixin, function () {
                        customBlock.blockMutator.afterBlockInit.call(customBlock.blockMutator, this);
                    }, customBlock.blockMutator.blockList);
                }
            }
        }
    }
    ngOnInit() {
        NgxBlocklyComponent.initCustomBlocks(this.customBlocks);
    }
    ngAfterViewInit() {
        const readOnly = this.config.readOnly || this.readOnly;
        this.config.readOnly = false;
        this.workspace = Blockly.inject(this.primaryContainer.nativeElement, this.config);
        this.workspace.addChangeListener(this._onWorkspaceChange.bind(this));
        this.workspace.fireChangeListener(new Blockly.Events.FinishedLoading());
        this.workspaceCreate.emit(this.workspace);
        this.resize();
        if (readOnly) {
            this.setReadonly(true);
            this.config.readOnly = true;
        }
    }
    ngOnChanges(changes) {
        //skip this if the change comes before we are initialized
        if (changes.readOnly && this._secondaryWorkspace) {
            this.setReadonly(changes.readOnly.currentValue);
        }
    }
    ngOnDestroy() {
        if (this.workspace) {
            this.workspace.dispose();
        }
        if (this._secondaryWorkspace) {
            this._secondaryWorkspace.dispose();
        }
    }
    onResize(event) {
        clearTimeout(this._resizeTimeout);
        this._resizeTimeout = setTimeout(() => this.resize(), 200);
    }
    /**
     * Generate code for all blocks in the workspace to the specified output.
     * @param workspaceId Workspace to generate code from.
     */
    workspaceToCode(workspaceId) {
        for (const generator of this.config.generators) {
            switch (generator) {
                case NgxBlocklyGenerator.DART:
                    this.dartCode.emit(Blockly[NgxBlocklyGenerator.DART].workspaceToCode(Blockly.Workspace.getById(workspaceId)));
                    break;
                case NgxBlocklyGenerator.LUA:
                    this.luaCode.emit(Blockly[NgxBlocklyGenerator.LUA].workspaceToCode(Blockly.Workspace.getById(workspaceId)));
                    break;
                case NgxBlocklyGenerator.JAVASCRIPT:
                    this.javascriptCode.emit(Blockly[NgxBlocklyGenerator.JAVASCRIPT].workspaceToCode(Blockly.Workspace.getById(workspaceId)));
                    break;
                case NgxBlocklyGenerator.PHP:
                    this.phpCode.emit(Blockly[NgxBlocklyGenerator.PHP].workspaceToCode(Blockly.Workspace.getById(workspaceId)));
                    break;
                case NgxBlocklyGenerator.PYTHON:
                    this.pythonCode.emit(Blockly[NgxBlocklyGenerator.PYTHON].workspaceToCode(Blockly.Workspace.getById(workspaceId)));
                    break;
                case NgxBlocklyGenerator.XML:
                    this.xmlCode.emit(Blockly.Xml.domToPrettyText(Blockly.Xml.workspaceToDom(Blockly.Workspace.getById(workspaceId))));
                    break;
            }
        }
    }
    /**
     * Converts a DOM structure into properly indented text.
     * @return Text representation.
     */
    toXml() {
        return Blockly.Xml.domToPrettyText(Blockly.Xml.workspaceToDom(this.workspace));
    }
    /**
     * Clear the given workspace then decode an XML DOM and
     * create blocks on the workspace.
     * @param xml XML DOM..
     */
    fromXml(xml) {
        this._finishedLoading = false;
        Blockly.Xml.clearWorkspaceAndLoadFromXml(Blockly.Xml.textToDom(xml), this.workspace);
        if (this._secondaryWorkspace) {
            Blockly.Xml.clearWorkspaceAndLoadFromXml(Blockly.Xml.textToDom(xml), this._secondaryWorkspace);
        }
    }
    /**
     * Decode an XML DOM and create blocks on the workspace. Position the new
     * blocks immediately below prior blocks, aligned by their starting edge.
     * @param xml The XML DOM.
     */
    appendFromXml(xml) {
        Blockly.Xml.appendDomToWorkspace(Blockly.Xml.textToDom(xml), this.workspace);
        if (this._secondaryWorkspace) {
            Blockly.Xml.appendDomToWorkspace(Blockly.Xml.textToDom(xml), this._secondaryWorkspace);
        }
    }
    /**
     * Dispose of all blocks in workspace, with an optimization to prevent resizes.
     */
    clear() {
        if (this.workspace) {
            this.workspace.clear();
        }
    }
    /**
     * Clear the undo/redo stacks.
     */
    clearUndo() {
        if (this.workspace) {
            this.workspace.clearUndo();
        }
    }
    /**
     * Clear the reference to the current gesture.
     */
    clearGesture() {
        if (this.workspace) {
            this.workspace.clearGesture();
        }
    }
    /**
     * Clear search input and result set.
     */
    clearSearch() {
        if (this.workspace) {
            const toolbox = this.workspace.getToolbox();
            if (toolbox && typeof toolbox.clearSearch === 'function') {
                toolbox.clearSearch();
            }
        }
    }
    /**
     * Size the workspace when the contents change. This also updates
     * scrollbars accordingly.
     */
    resize() {
        if (this.workspace) {
            Blockly.svgResize(this.workspace);
        }
        if (this._secondaryWorkspace) {
            Blockly.svgResize(this._secondaryWorkspace);
        }
    }
    setReadonly(readOnly) {
        this.readOnly = readOnly;
        if (readOnly) {
            this.secondaryContainer.nativeElement.classList.remove('hidden');
            if (!this._secondaryWorkspace) {
                const config = Object.assign({}, this.config);
                config.readOnly = true;
                this._secondaryWorkspace = Blockly.inject(this.secondaryContainer.nativeElement, config);
            }
            Blockly.Xml.clearWorkspaceAndLoadFromXml(Blockly.Xml.textToDom(this.toXml()), this._secondaryWorkspace);
        }
        else {
            if (this._secondaryWorkspace) {
                this.secondaryContainer.nativeElement.classList.add('hidden');
            }
        }
    }
    highlightBlock(blockId) {
        if (this.workspace) {
            this.workspace.highlightBlock(blockId);
        }
        if (this._secondaryWorkspace) {
            this._secondaryWorkspace.highlightBlock(blockId);
        }
    }
    _onWorkspaceChange(event) {
        this.workspaceChange.emit(event);
        if (event.type === Blockly.Events.FINISHED_LOADING) {
            this._finishedLoading = true;
        }
        if (this._finishedLoading) {
            if (event instanceof Blockly.Events.BlockBase ||
                event instanceof Blockly.Events.VarBase ||
                event instanceof Blockly.Events.CommentBase) {
                this.workspaceToCode(event.workspaceId);
            }
            if (event.type === Blockly.Events.TOOLBOX_ITEM_SELECT) {
                this.toolboxChange.emit(event);
            }
        }
    }
}
NgxBlocklyComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.4", ngImport: i0, type: NgxBlocklyComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });
NgxBlocklyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.4", type: NgxBlocklyComponent, selector: "ngx-blockly", inputs: { config: "config", customBlocks: "customBlocks", readOnly: "readOnly" }, outputs: { workspaceCreate: "workspaceCreate", workspaceChange: "workspaceChange", toolboxChange: "toolboxChange", dartCode: "dartCode", javascriptCode: "javascriptCode", luaCode: "luaCode", phpCode: "phpCode", pythonCode: "pythonCode", xmlCode: "xmlCode" }, host: { listeners: { "window:resize": "onResize($event)" } }, viewQueries: [{ propertyName: "primaryContainer", first: true, predicate: ["primaryContainer"], descendants: true }, { propertyName: "secondaryContainer", first: true, predicate: ["secondaryContainer"], descendants: true }], usesOnChanges: true, ngImport: i0, template: "<div id=\"blockly-wrapper\" class=\"blockly-wrapper\">\n    <div #primaryContainer class=\"blockly\"></div>\n    <div #secondaryContainer class=\"blockly hidden\"></div>\n</div>\n", styles: [".blockly-wrapper{width:100%;height:100%}.blockly{position:absolute;width:100%;min-width:100%;height:100%;min-height:100%}.blockly{z-index:1}.blockly.hidden{display:none;z-index:0}::ng-deep .blockly .blocklyToolboxDiv{display:flex;flex-direction:column;justify-content:flex-start;overflow:auto}::ng-deep .blockly .blocklyToolboxDiv .blocklyTreeRoot{overflow-x:visible;overflow-y:auto;flex:1}::ng-deep .blockly .blocklyToolboxDiv input.searchbar{border:none;background-color:transparent;font-size:16px;padding:8px 25px 4px;border-bottom:1px solid #ccc;background:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0Ij48cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE1LjUgMTRoLS43OWwtLjI4LS4yN0MxNS40MSAxMi41OSAxNiAxMS4xMSAxNiA5LjUgMTYgNS45MSAxMy4wOSAzIDkuNSAzUzMgNS45MSAzIDkuNSA1LjkxIDE2IDkuNSAxNmMxLjYxIDAgMy4wOS0uNTkgNC4yMy0xLjU3bC4yNy4yOHYuNzlsNSA0Ljk5TDIwLjQ5IDE5bC00Ljk5LTV6bS02IDBDNy4wMSAxNCA1IDExLjk5IDUgOS41UzcuMDEgNSA5LjUgNSAxNCA3LjAxIDE0IDkuNSAxMS45OSAxNCA5LjUgMTR6Ii8+PC9zdmc+) no-repeat right center;min-width:120px}::ng-deep .blockly .blocklyToolboxDiv input.searchbar:focus{outline:none}\n"] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.4", ngImport: i0, type: NgxBlocklyComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'ngx-blockly',
                    templateUrl: './ngx-blockly.component.html',
                    styleUrls: ['./ngx-blockly.component.css']
                }]
        }], propDecorators: { config: [{
                type: Input
            }], customBlocks: [{
                type: Input
            }], readOnly: [{
                type: Input
            }], workspaceCreate: [{
                type: Output
            }], workspaceChange: [{
                type: Output
            }], toolboxChange: [{
                type: Output
            }], dartCode: [{
                type: Output
            }], javascriptCode: [{
                type: Output
            }], luaCode: [{
                type: Output
            }], phpCode: [{
                type: Output
            }], pythonCode: [{
                type: Output
            }], xmlCode: [{
                type: Output
            }], primaryContainer: [{
                type: ViewChild,
                args: ['primaryContainer']
            }], secondaryContainer: [{
                type: ViewChild,
                args: ['secondaryContainer']
            }], onResize: [{
                type: HostListener,
                args: ['window:resize', ['$event']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWJsb2NrbHkuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWJsb2NrbHkvc3JjL2xpYi9uZ3gtYmxvY2tseS9uZ3gtYmxvY2tseS5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtYmxvY2tseS9zcmMvbGliL25neC1ibG9ja2x5L25neC1ibG9ja2x5LmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFSCxVQUFVLEVBQ1YsU0FBUyxFQUNULFlBQVksRUFDWixZQUFZLEVBQ1osS0FBSyxFQUlMLE1BQU0sRUFFTixTQUFTLEVBQ1osTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFtQixtQkFBbUIsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBRTNFLE9BQU8sS0FBSyxPQUFPLE1BQU0sY0FBYyxDQUFDO0FBQ3hDLE9BQU8sY0FBYyxDQUFDO0FBQ3RCLE9BQU8sb0JBQW9CLENBQUM7QUFDNUIsT0FBTyxhQUFhLENBQUM7QUFDckIsT0FBTyxhQUFhLENBQUM7QUFDckIsT0FBTyxnQkFBZ0IsQ0FBQzs7QUFReEIsTUFBTSxPQUFPLG1CQUFtQjtJQUxoQztRQU9vQixXQUFNLEdBQXFCLEVBQUUsQ0FBQztRQUM5QixpQkFBWSxHQUFrQixFQUFFLENBQUM7UUFDakMsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUNoQixvQkFBZSxHQUF1QyxJQUFJLFlBQVksRUFBd0IsQ0FBQztRQUMvRixvQkFBZSxHQUEwQyxJQUFJLFlBQVksRUFBMkIsQ0FBQztRQUNyRyxrQkFBYSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBQzNELGFBQVEsR0FBeUIsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUM1RCxtQkFBYyxHQUF5QixJQUFJLFlBQVksRUFBVSxDQUFDO1FBQ2xFLFlBQU8sR0FBeUIsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUMz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Q0FBQyxLQUFLLENBQUMsQ0FBQzthQUNsQztTQUNKO0lBQ0wsQ0FBQzs7Z0hBalNRLG1CQUFtQjtvR0FBbkIsbUJBQW1CLDRyQkM3QmhDLHFMQUlBOzJGRHlCYSxtQkFBbUI7a0JBTC9CLFNBQVM7bUJBQUM7b0JBQ1AsUUFBUSxFQUFFLGFBQWE7b0JBQ3ZCLFdBQVcsRUFBRSw4QkFBOEI7b0JBQzNDLFNBQVMsRUFBRSxDQUFDLDZCQUE2QixDQUFDO2lCQUM3Qzs4QkFHbUIsTUFBTTtzQkFBckIsS0FBSztnQkFDVSxZQUFZO3NCQUEzQixLQUFLO2dCQUNVLFFBQVE7c0JBQXZCLEtBQUs7Z0JBQ1csZUFBZTtzQkFBL0IsTUFBTTtnQkFDVSxlQUFlO3NCQUEvQixNQUFNO2dCQUNVLGFBQWE7c0JBQTdCLE1BQU07Z0JBQ1UsUUFBUTtzQkFBeEIsTUFBTTtnQkFDVSxjQUFjO3NCQUE5QixNQUFNO2dCQUNVLE9BQU87c0JBQXZCLE1BQU07Z0JBQ1UsT0FBTztzQkFBdkIsTUFBTTtnQkFDVSxVQUFVO3NCQUExQixNQUFNO2dCQUNVLE9BQU87c0JBQXZCLE1BQU07Z0JBRXdCLGdCQUFnQjtzQkFBOUMsU0FBUzt1QkFBQyxrQkFBa0I7Z0JBQ0ksa0JBQWtCO3NCQUFsRCxTQUFTO3VCQUFDLG9CQUFvQjtnQkFpSC9CLFFBQVE7c0JBRFAsWUFBWTt1QkFBQyxlQUFlLEVBQUUsQ0FBQyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIEFmdGVyVmlld0luaXQsXG4gICAgRWxlbWVudFJlZixcbiAgICBDb21wb25lbnQsXG4gICAgRXZlbnRFbWl0dGVyLFxuICAgIEhvc3RMaXN0ZW5lcixcbiAgICBJbnB1dCxcbiAgICBPbkNoYW5nZXMsXG4gICAgT25EZXN0cm95LFxuICAgIE9uSW5pdCxcbiAgICBPdXRwdXQsXG4gICAgU2ltcGxlQ2hhbmdlLFxuICAgIFZpZXdDaGlsZFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7Tmd4QmxvY2tseUNvbmZpZywgTmd4QmxvY2tseUdlbmVyYXRvcn0gZnJvbSAnLi9uZ3gtYmxvY2tseS5jb25maWcnO1xuaW1wb3J0IHtDdXN0b21CbG9ja30gZnJvbSAnLi9tb2RlbHMvY3VzdG9tLWJsb2NrJztcbmltcG9ydCAqIGFzIEJsb2NrbHkgZnJvbSAnYmxvY2tseS9jb3JlJztcbmltcG9ydCAnYmxvY2tseS9kYXJ0JztcbmltcG9ydCAnYmxvY2tseS9qYXZhc2NyaXB0JztcbmltcG9ydCAnYmxvY2tseS9sdWEnO1xuaW1wb3J0ICdibG9ja2x5L3BocCc7XG5pbXBvcnQgJ2Jsb2NrbHkvcHl0aG9uJztcbmltcG9ydCB7Tmd4QmxvY2tseVRvb2xib3h9IGZyb20gJy4vcGx1Z2lucy9uZ3gtYmxvY2tseS50b29sYm94JztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICduZ3gtYmxvY2tseScsXG4gICAgdGVtcGxhdGVVcmw6ICcuL25neC1ibG9ja2x5LmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9uZ3gtYmxvY2tseS5jb21wb25lbnQuY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgTmd4QmxvY2tseUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuXG4gICAgQElucHV0KCkgcHVibGljIGNvbmZpZzogTmd4QmxvY2tseUNvbmZpZyA9IHt9O1xuICAgIEBJbnB1dCgpIHB1YmxpYyBjdXN0b21CbG9ja3M6IEN1c3RvbUJsb2NrW10gPSBbXTtcbiAgICBASW5wdXQoKSBwdWJsaWMgcmVhZE9ubHkgPSBmYWxzZTtcbiAgICBAT3V0cHV0KCkgcHVibGljIHdvcmtzcGFjZUNyZWF0ZTogRXZlbnRFbWl0dGVyPEJsb2NrbHkuV29ya3NwYWNlU3ZnPiA9IG5ldyBFdmVudEVtaXR0ZXI8QmxvY2tseS5Xb3Jrc3BhY2VTdmc+KCk7XG4gICAgQE91dHB1dCgpIHB1YmxpYyB3b3Jrc3BhY2VDaGFuZ2U6IEV2ZW50RW1pdHRlcjxCbG9ja2x5LkV2ZW50cy5BYnN0cmFjdD4gPSBuZXcgRXZlbnRFbWl0dGVyPEJsb2NrbHkuRXZlbnRzLkFic3RyYWN0PigpO1xuICAgIEBPdXRwdXQoKSBwdWJsaWMgdG9vbGJveENoYW5nZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgICBAT3V0cHV0KCkgcHVibGljIGRhcnRDb2RlOiBFdmVudEVtaXR0ZXI8c3RyaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuICAgIEBPdXRwdXQoKSBwdWJsaWMgamF2YXNjcmlwdENvZGU6IEV2ZW50RW1pdHRlcjxzdHJpbmc+ID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG4gICAgQE91dHB1dCgpIHB1YmxpYyBsdWFDb2RlOiBFdmVudEVtaXR0ZXI8c3RyaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuICAgIEBPdXRwdXQoKSBwdWJsaWMgcGhwQ29kZTogRXZlbnRFbWl0dGVyPHN0cmluZz4gPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcbiAgICBAT3V0cHV0KCkgcHVibGljIHB5dGhvbkNvZGU6IEV2ZW50RW1pdHRlcjxzdHJpbmc+ID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG4gICAgQE91dHB1dCgpIHB1YmxpYyB4bWxDb2RlOiBFdmVudEVtaXR0ZXI8c3RyaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuXG4gICAgQFZpZXdDaGlsZCgncHJpbWFyeUNvbnRhaW5lcicpIHByaW1hcnlDb250YWluZXI6IEVsZW1lbnRSZWY7XG4gICAgQFZpZXdDaGlsZCgnc2Vjb25kYXJ5Q29udGFpbmVyJykgc2Vjb25kYXJ5Q29udGFpbmVyOiBFbGVtZW50UmVmO1xuICAgIHB1YmxpYyB3b3Jrc3BhY2U6IEJsb2NrbHkuV29ya3NwYWNlU3ZnO1xuICAgIHByaXZhdGUgX3NlY29uZGFyeVdvcmtzcGFjZTogQmxvY2tseS5Xb3Jrc3BhY2VTdmc7XG4gICAgcHJpdmF0ZSBfcmVzaXplVGltZW91dDtcbiAgICBwcml2YXRlIF9maW5pc2hlZExvYWRpbmcgPSBmYWxzZTtcblxuICAgIHB1YmxpYyBzdGF0aWMgaW5pdEN1c3RvbUJsb2NrcyhibG9ja3M6IEN1c3RvbUJsb2NrW10pIHtcbiAgICAgICAgaWYgKGJsb2Nrcykge1xuICAgICAgICAgICAgZm9yIChjb25zdCBjdXN0b21CbG9jayBvZiBibG9ja3MpIHtcbiAgICAgICAgICAgICAgICBCbG9ja2x5LkJsb2Nrc1tjdXN0b21CbG9jay50eXBlXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYmxvY2sgPSBuZXcgY3VzdG9tQmxvY2suY2xhc3MoY3VzdG9tQmxvY2sudHlwZSwgY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLCAuLi5jdXN0b21CbG9jay5hcmdzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrLmluaXQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1peGluKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tJbnN0YW5jZTogYmxvY2tcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIEJsb2NrbHlbTmd4QmxvY2tseUdlbmVyYXRvci5QWVRIT05dICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBCbG9ja2x5W05neEJsb2NrbHlHZW5lcmF0b3IuUFlUSE9OXVtjdXN0b21CbG9jay50eXBlXSA9IGZ1bmN0aW9uIChiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYi5ibG9ja0luc3RhbmNlLnRvUHl0aG9uQ29kZShiKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBCbG9ja2x5W05neEJsb2NrbHlHZW5lcmF0b3IuREFSVF0gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIEJsb2NrbHlbTmd4QmxvY2tseUdlbmVyYXRvci5EQVJUXVtjdXN0b21CbG9jay50eXBlXSA9IGZ1bmN0aW9uIChiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYi5ibG9ja0luc3RhbmNlLnRvRGFydENvZGUoYik7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgQmxvY2tseVtOZ3hCbG9ja2x5R2VuZXJhdG9yLkpBVkFTQ1JJUFRdICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBCbG9ja2x5W05neEJsb2NrbHlHZW5lcmF0b3IuSkFWQVNDUklQVF1bY3VzdG9tQmxvY2sudHlwZV0gPSBmdW5jdGlvbiAoYikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGIuYmxvY2tJbnN0YW5jZS50b0phdmFTY3JpcHRDb2RlKGIpO1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIEJsb2NrbHlbTmd4QmxvY2tseUdlbmVyYXRvci5MVUFdICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBCbG9ja2x5W05neEJsb2NrbHlHZW5lcmF0b3IuTFVBXVtjdXN0b21CbG9jay50eXBlXSA9IGZ1bmN0aW9uIChiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYi5ibG9ja0luc3RhbmNlLnRvTHVhQ29kZShiKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBCbG9ja2x5W05neEJsb2NrbHlHZW5lcmF0b3IuUEhQXSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgQmxvY2tseVtOZ3hCbG9ja2x5R2VuZXJhdG9yLlBIUF1bY3VzdG9tQmxvY2sudHlwZV0gPSBmdW5jdGlvbiAoYikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGIuYmxvY2tJbnN0YW5jZS50b1BIUENvZGUoYik7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjdXN0b21CbG9jay5ibG9ja011dGF0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbXV0YXRvcl9taXhpbjogYW55ID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbXV0YXRpb25Ub0RvbTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjdXN0b21CbG9jay5ibG9ja011dGF0b3IubXV0YXRpb25Ub0RvbS5jYWxsKGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvciwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVG9NdXRhdGlvbjogZnVuY3Rpb24gKHhtbEVsZW1lbnQ6IGFueSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvci5kb21Ub011dGF0aW9uLmNhbGwoY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLCB0aGlzLCB4bWxFbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvci5ibG9ja0xpc3QgJiYgY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLmJsb2NrTGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtdXRhdG9yX21peGluLmRlY29tcG9zZSA9IGZ1bmN0aW9uICh3b3Jrc3BhY2U6IGFueSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjdXN0b21CbG9jay5ibG9ja011dGF0b3IuZGVjb21wb3NlLmNhbGwoY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLCB0aGlzLCB3b3Jrc3BhY2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG11dGF0b3JfbWl4aW4uY29tcG9zZSA9IGZ1bmN0aW9uICh0b3BCbG9jazogYW55KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLmNvbXBvc2UuY2FsbChjdXN0b21CbG9jay5ibG9ja011dGF0b3IsIHRoaXMsIHRvcEJsb2NrKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICBtdXRhdG9yX21peGluLnNhdmVDb25uZWN0aW9ucyA9IGZ1bmN0aW9uIChjb250YWluZXJCbG9jazogYW55KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLnNhdmVDb25uZWN0aW9ucy5jYWxsKGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvciwgdGhpcywgY29udGFpbmVyQmxvY2spO1xuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBCbG9ja2x5LkV4dGVuc2lvbnMudW5yZWdpc3RlcihjdXN0b21CbG9jay5ibG9ja011dGF0b3IubmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIEJsb2NrbHkuRXh0ZW5zaW9ucy5yZWdpc3Rlck11dGF0b3IoXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21CbG9jay5ibG9ja011dGF0b3IubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG11dGF0b3JfbWl4aW4sXG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLmFmdGVyQmxvY2tJbml0LmNhbGwoY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21CbG9jay5ibG9ja011dGF0b3IuYmxvY2tMaXN0XG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIE5neEJsb2NrbHlDb21wb25lbnQuaW5pdEN1c3RvbUJsb2Nrcyh0aGlzLmN1c3RvbUJsb2Nrcyk7XG4gICAgfVxuXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgICAgICBjb25zdCByZWFkT25seSA9IHRoaXMuY29uZmlnLnJlYWRPbmx5IHx8IHRoaXMucmVhZE9ubHk7XG4gICAgICAgIHRoaXMuY29uZmlnLnJlYWRPbmx5ID0gZmFsc2U7XG4gICAgICAgIHRoaXMud29ya3NwYWNlID0gQmxvY2tseS5pbmplY3QodGhpcy5wcmltYXJ5Q29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsIHRoaXMuY29uZmlnKTtcbiAgICAgICAgdGhpcy53b3Jrc3BhY2UuYWRkQ2hhbmdlTGlzdGVuZXIodGhpcy5fb25Xb3Jrc3BhY2VDaGFuZ2UuYmluZCh0aGlzKSk7XG4gICAgICAgIHRoaXMud29ya3NwYWNlLmZpcmVDaGFuZ2VMaXN0ZW5lcihuZXcgQmxvY2tseS5FdmVudHMuRmluaXNoZWRMb2FkaW5nKCkpO1xuICAgICAgICB0aGlzLndvcmtzcGFjZUNyZWF0ZS5lbWl0KHRoaXMud29ya3NwYWNlKTtcbiAgICAgICAgdGhpcy5yZXNpemUoKTtcbiAgICAgICAgaWYgKHJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aGlzLnNldFJlYWRvbmx5KHRydWUpO1xuICAgICAgICAgICAgdGhpcy5jb25maWcucmVhZE9ubHkgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogeyBbcHJvcEtleTogc3RyaW5nXTogU2ltcGxlQ2hhbmdlIH0pIHtcbiAgICAgICAgLy9za2lwIHRoaXMgaWYgdGhlIGNoYW5nZSBjb21lcyBiZWZvcmUgd2UgYXJlIGluaXRpYWxpemVkXG4gICAgICAgIGlmIChjaGFuZ2VzLnJlYWRPbmx5ICYmIHRoaXMuX3NlY29uZGFyeVdvcmtzcGFjZSkge1xuICAgICAgICAgICAgdGhpcy5zZXRSZWFkb25seShjaGFuZ2VzLnJlYWRPbmx5LmN1cnJlbnRWYWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgaWYgKHRoaXMud29ya3NwYWNlKSB7XG4gICAgICAgICAgICB0aGlzLndvcmtzcGFjZS5kaXNwb3NlKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuX3NlY29uZGFyeVdvcmtzcGFjZSkge1xuICAgICAgICAgICAgdGhpcy5fc2Vjb25kYXJ5V29ya3NwYWNlLmRpc3Bvc2UoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzpyZXNpemUnLCBbJyRldmVudCddKVxuICAgIG9uUmVzaXplKGV2ZW50KSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9yZXNpemVUaW1lb3V0KTtcbiAgICAgICAgdGhpcy5fcmVzaXplVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gdGhpcy5yZXNpemUoKSwgMjAwKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZW5lcmF0ZSBjb2RlIGZvciBhbGwgYmxvY2tzIGluIHRoZSB3b3Jrc3BhY2UgdG8gdGhlIHNwZWNpZmllZCBvdXRwdXQuXG4gICAgICogQHBhcmFtIHdvcmtzcGFjZUlkIFdvcmtzcGFjZSB0byBnZW5lcmF0ZSBjb2RlIGZyb20uXG4gICAgICovXG4gICAgcHVibGljIHdvcmtzcGFjZVRvQ29kZSh3b3Jrc3BhY2VJZDogc3RyaW5nKSB7XG4gICAgICAgIGZvciAoY29uc3QgZ2VuZXJhdG9yIG9mIHRoaXMuY29uZmlnLmdlbmVyYXRvcnMpIHtcbiAgICAgICAgICAgIHN3aXRjaCAoZ2VuZXJhdG9yKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBOZ3hCbG9ja2x5R2VuZXJhdG9yLkRBUlQ6XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGFydENvZGUuZW1pdChCbG9ja2x5W05neEJsb2NrbHlHZW5lcmF0b3IuREFSVF0ud29ya3NwYWNlVG9Db2RlKEJsb2NrbHkuV29ya3NwYWNlLmdldEJ5SWQod29ya3NwYWNlSWQpKSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgTmd4QmxvY2tseUdlbmVyYXRvci5MVUE6XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubHVhQ29kZS5lbWl0KEJsb2NrbHlbTmd4QmxvY2tseUdlbmVyYXRvci5MVUFdLndvcmtzcGFjZVRvQ29kZShCbG9ja2x5LldvcmtzcGFjZS5nZXRCeUlkKHdvcmtzcGFjZUlkKSkpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIE5neEJsb2NrbHlHZW5lcmF0b3IuSkFWQVNDUklQVDpcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5qYXZhc2NyaXB0Q29kZS5lbWl0KEJsb2NrbHlbTmd4QmxvY2tseUdlbmVyYXRvci5KQVZBU0NSSVBUXS53b3Jrc3BhY2VUb0NvZGUoQmxvY2tseS5Xb3Jrc3BhY2UuZ2V0QnlJZCh3b3Jrc3BhY2VJZCkpKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBOZ3hCbG9ja2x5R2VuZXJhdG9yLlBIUDpcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5waHBDb2RlLmVtaXQoQmxvY2tseVtOZ3hCbG9ja2x5R2VuZXJhdG9yLlBIUF0ud29ya3NwYWNlVG9Db2RlKEJsb2NrbHkuV29ya3NwYWNlLmdldEJ5SWQod29ya3NwYWNlSWQpKSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgTmd4QmxvY2tseUdlbmVyYXRvci5QWVRIT046XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHl0aG9uQ29kZS5lbWl0KEJsb2NrbHlbTmd4QmxvY2tseUdlbmVyYXRvci5QWVRIT05dLndvcmtzcGFjZVRvQ29kZShCbG9ja2x5LldvcmtzcGFjZS5nZXRCeUlkKHdvcmtzcGFjZUlkKSkpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIE5neEJsb2NrbHlHZW5lcmF0b3IuWE1MOlxuICAgICAgICAgICAgICAgICAgICB0aGlzLnhtbENvZGUuZW1pdChCbG9ja2x5LlhtbC5kb21Ub1ByZXR0eVRleHQoQmxvY2tseS5YbWwud29ya3NwYWNlVG9Eb20oQmxvY2tseS5Xb3Jrc3BhY2UuZ2V0QnlJZCh3b3Jrc3BhY2VJZCkpKSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ29udmVydHMgYSBET00gc3RydWN0dXJlIGludG8gcHJvcGVybHkgaW5kZW50ZWQgdGV4dC5cbiAgICAgKiBAcmV0dXJuIFRleHQgcmVwcmVzZW50YXRpb24uXG4gICAgICovXG4gICAgcHVibGljIHRvWG1sKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBCbG9ja2x5LlhtbC5kb21Ub1ByZXR0eVRleHQoQmxvY2tseS5YbWwud29ya3NwYWNlVG9Eb20odGhpcy53b3Jrc3BhY2UpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbGVhciB0aGUgZ2l2ZW4gd29ya3NwYWNlIHRoZW4gZGVjb2RlIGFuIFhNTCBET00gYW5kXG4gICAgICogY3JlYXRlIGJsb2NrcyBvbiB0aGUgd29ya3NwYWNlLlxuICAgICAqIEBwYXJhbSB4bWwgWE1MIERPTS4uXG4gICAgICovXG4gICAgcHVibGljIGZyb21YbWwoeG1sOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5fZmluaXNoZWRMb2FkaW5nID0gZmFsc2U7XG4gICAgICAgIEJsb2NrbHkuWG1sLmNsZWFyV29ya3NwYWNlQW5kTG9hZEZyb21YbWwoQmxvY2tseS5YbWwudGV4dFRvRG9tKHhtbCksIHRoaXMud29ya3NwYWNlKTtcbiAgICAgICAgaWYgKHRoaXMuX3NlY29uZGFyeVdvcmtzcGFjZSkge1xuICAgICAgICAgICAgQmxvY2tseS5YbWwuY2xlYXJXb3Jrc3BhY2VBbmRMb2FkRnJvbVhtbChCbG9ja2x5LlhtbC50ZXh0VG9Eb20oeG1sKSwgdGhpcy5fc2Vjb25kYXJ5V29ya3NwYWNlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlY29kZSBhbiBYTUwgRE9NIGFuZCBjcmVhdGUgYmxvY2tzIG9uIHRoZSB3b3Jrc3BhY2UuIFBvc2l0aW9uIHRoZSBuZXdcbiAgICAgKiBibG9ja3MgaW1tZWRpYXRlbHkgYmVsb3cgcHJpb3IgYmxvY2tzLCBhbGlnbmVkIGJ5IHRoZWlyIHN0YXJ0aW5nIGVkZ2UuXG4gICAgICogQHBhcmFtIHhtbCBUaGUgWE1MIERPTS5cbiAgICAgKi9cbiAgICBwdWJsaWMgYXBwZW5kRnJvbVhtbCh4bWw6IHN0cmluZykge1xuICAgICAgICBCbG9ja2x5LlhtbC5hcHBlbmREb21Ub1dvcmtzcGFjZShCbG9ja2x5LlhtbC50ZXh0VG9Eb20oeG1sKSwgdGhpcy53b3Jrc3BhY2UpO1xuICAgICAgICBpZiAodGhpcy5fc2Vjb25kYXJ5V29ya3NwYWNlKSB7XG4gICAgICAgICAgICBCbG9ja2x5LlhtbC5hcHBlbmREb21Ub1dvcmtzcGFjZShCbG9ja2x5LlhtbC50ZXh0VG9Eb20oeG1sKSwgdGhpcy5fc2Vjb25kYXJ5V29ya3NwYWNlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERpc3Bvc2Ugb2YgYWxsIGJsb2NrcyBpbiB3b3Jrc3BhY2UsIHdpdGggYW4gb3B0aW1pemF0aW9uIHRvIHByZXZlbnQgcmVzaXplcy5cbiAgICAgKi9cbiAgICBwdWJsaWMgY2xlYXIoKSB7XG4gICAgICAgIGlmICh0aGlzLndvcmtzcGFjZSkge1xuICAgICAgICAgICAgdGhpcy53b3Jrc3BhY2UuY2xlYXIoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsZWFyIHRoZSB1bmRvL3JlZG8gc3RhY2tzLlxuICAgICAqL1xuICAgIHB1YmxpYyBjbGVhclVuZG8oKSB7XG4gICAgICAgIGlmICh0aGlzLndvcmtzcGFjZSkge1xuICAgICAgICAgICAgdGhpcy53b3Jrc3BhY2UuY2xlYXJVbmRvKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbGVhciB0aGUgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50IGdlc3R1cmUuXG4gICAgICovXG4gICAgcHVibGljIGNsZWFyR2VzdHVyZSgpIHtcbiAgICAgICAgaWYgKHRoaXMud29ya3NwYWNlKSB7XG4gICAgICAgICAgICB0aGlzLndvcmtzcGFjZS5jbGVhckdlc3R1cmUoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsZWFyIHNlYXJjaCBpbnB1dCBhbmQgcmVzdWx0IHNldC5cbiAgICAgKi9cbiAgICBwdWJsaWMgY2xlYXJTZWFyY2goKSB7XG4gICAgICAgIGlmICh0aGlzLndvcmtzcGFjZSkge1xuICAgICAgICAgICAgY29uc3QgdG9vbGJveCA9IHRoaXMud29ya3NwYWNlLmdldFRvb2xib3goKSBhcyBOZ3hCbG9ja2x5VG9vbGJveDtcbiAgICAgICAgICAgIGlmICh0b29sYm94ICYmIHR5cGVvZiB0b29sYm94LmNsZWFyU2VhcmNoID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgdG9vbGJveC5jbGVhclNlYXJjaCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2l6ZSB0aGUgd29ya3NwYWNlIHdoZW4gdGhlIGNvbnRlbnRzIGNoYW5nZS4gVGhpcyBhbHNvIHVwZGF0ZXNcbiAgICAgKiBzY3JvbGxiYXJzIGFjY29yZGluZ2x5LlxuICAgICAqL1xuICAgIHB1YmxpYyByZXNpemUoKSB7XG4gICAgICAgIGlmICh0aGlzLndvcmtzcGFjZSkge1xuICAgICAgICAgICAgQmxvY2tseS5zdmdSZXNpemUodGhpcy53b3Jrc3BhY2UpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLl9zZWNvbmRhcnlXb3Jrc3BhY2UpIHtcbiAgICAgICAgICAgIEJsb2NrbHkuc3ZnUmVzaXplKHRoaXMuX3NlY29uZGFyeVdvcmtzcGFjZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0UmVhZG9ubHkocmVhZE9ubHk6IGJvb2xlYW4pIHtcbiAgICAgICAgdGhpcy5yZWFkT25seSA9IHJlYWRPbmx5O1xuICAgICAgICBpZiAocmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRoaXMuc2Vjb25kYXJ5Q29udGFpbmVyLm5hdGl2ZUVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSgnaGlkZGVuJyk7XG4gICAgICAgICAgICBpZiAoIXRoaXMuX3NlY29uZGFyeVdvcmtzcGFjZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbmZpZyA9IHsuLi50aGlzLmNvbmZpZ307XG4gICAgICAgICAgICAgICAgY29uZmlnLnJlYWRPbmx5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0aGlzLl9zZWNvbmRhcnlXb3Jrc3BhY2UgPSBCbG9ja2x5LmluamVjdCh0aGlzLnNlY29uZGFyeUNvbnRhaW5lci5uYXRpdmVFbGVtZW50LCBjb25maWcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgQmxvY2tseS5YbWwuY2xlYXJXb3Jrc3BhY2VBbmRMb2FkRnJvbVhtbChCbG9ja2x5LlhtbC50ZXh0VG9Eb20odGhpcy50b1htbCgpKSwgdGhpcy5fc2Vjb25kYXJ5V29ya3NwYWNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9zZWNvbmRhcnlXb3Jrc3BhY2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNlY29uZGFyeUNvbnRhaW5lci5uYXRpdmVFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2hpZGRlbicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGhpZ2hsaWdodEJsb2NrKGJsb2NrSWQ6IHN0cmluZykge1xuICAgICAgICBpZiAodGhpcy53b3Jrc3BhY2UpIHtcbiAgICAgICAgICAgIHRoaXMud29ya3NwYWNlLmhpZ2hsaWdodEJsb2NrKGJsb2NrSWQpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLl9zZWNvbmRhcnlXb3Jrc3BhY2UpIHtcbiAgICAgICAgICAgIHRoaXMuX3NlY29uZGFyeVdvcmtzcGFjZS5oaWdobGlnaHRCbG9jayhibG9ja0lkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX29uV29ya3NwYWNlQ2hhbmdlKGV2ZW50OiBhbnkpIHtcbiAgICAgICAgdGhpcy53b3Jrc3BhY2VDaGFuZ2UuZW1pdChldmVudCk7XG4gICAgICAgIGlmIChldmVudC50eXBlID09PSBCbG9ja2x5LkV2ZW50cy5GSU5JU0hFRF9MT0FESU5HKSB7XG4gICAgICAgICAgICB0aGlzLl9maW5pc2hlZExvYWRpbmcgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLl9maW5pc2hlZExvYWRpbmcpIHtcbiAgICAgICAgICAgIGlmIChldmVudCBpbnN0YW5jZW9mIEJsb2NrbHkuRXZlbnRzLkJsb2NrQmFzZSB8fFxuICAgICAgICAgICAgICAgIGV2ZW50IGluc3RhbmNlb2YgQmxvY2tseS5FdmVudHMuVmFyQmFzZSB8fFxuICAgICAgICAgICAgICAgIGV2ZW50IGluc3RhbmNlb2YgQmxvY2tseS5FdmVudHMuQ29tbWVudEJhc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLndvcmtzcGFjZVRvQ29kZShldmVudC53b3Jrc3BhY2VJZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gQmxvY2tseS5FdmVudHMuVE9PTEJPWF9JVEVNX1NFTEVDVCkge1xuICAgICAgICAgICAgICAgIHRoaXMudG9vbGJveENoYW5nZS5lbWl0KGV2ZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cbiIsIjxkaXYgaWQ9XCJibG9ja2x5LXdyYXBwZXJcIiBjbGFzcz1cImJsb2NrbHktd3JhcHBlclwiPlxuICAgIDxkaXYgI3ByaW1hcnlDb250YWluZXIgY2xhc3M9XCJibG9ja2x5XCI+PC9kaXY+XG4gICAgPGRpdiAjc2Vjb25kYXJ5Q29udGFpbmVyIGNsYXNzPVwiYmxvY2tseSBoaWRkZW5cIj48L2Rpdj5cbjwvZGl2PlxuIl19